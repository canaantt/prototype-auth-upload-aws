<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.0-rc.2/jquery-ui.min.js" integrity="sha256-55Jz3pBCF8z9jBO1qQ7cIf0L+neuPTD1u7Ytzrp2dqo=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.224.1/aws-sdk.js"></script>
        <script src="./aws-cognito-sdk.js"></script>
        <script src="./amazon-cognito-identity.js"></script>
        <title>
            Prototype AWS Cognito + API Gateway + Lambda + DynamoDB + S3
        </title>
    </head>
    <body>
        <h1>Prototype AWS Cognito + API Gateway + Lambda + DynamoDB + S3</h1>
        <div class="well-big">
            <section class="form-wrap">
                <h1>Register</h1>
                <form id="registrationForm" onsubmit="handleRegister()">
                  <input type="email" id="emailInputRegister" placeholder="Email" pattern=".*" required>
                  <input type="password" id="passwordInputRegister" placeholder="Password" pattern=".*" required>
                  <input type="password" id="password2InputRegister" placeholder="Confirm Password" pattern=".*" required>
                  <input type="submit" value="Register">
                </form>
            </section>
        </div>
        <div class="well-big">
            <section class="form-wrap">
                <h1>Verify Email</h1>
                <form id="verifyForm" onsubmit="handleVerify()">
                  <input type="email" id="emailInputVerify" placeholder="Email" required>
                  <input type="text" id="codeInputVerify" placeholder="Verification Code" pattern=".*" required>
                  <input type="submit" value="Verify">
                </form>
            </section>
        </div>
        <hr>
        <div class="well-big">
            <section class="form-wrap">
                <h1>Sign In</h1>
                <form id="signinForm" onsubmit="handleSignin()">
                  <input type="email" id="emailInputSignin" placeholder="Email" required>
                  <input type="password" id="passwordInputSignin" placeholder="Password" pattern=".*" required>
                  <input type="submit" value="Sign in">
                </form>
            </section>
        </div>
        <div class="well-big">
            <h1>Sign Out</h1>
            <button onclick="signOut()">Sign Out</button>
        </div>
        <div class="well-big">
            <h1>Assign User Group</h1>
            <select onchange="assignUserToGroup(this.value)"> 
                <option value="admin">Admin</option>
                <option value="readwrite">Read And Write</option>
                <option value="readonly">Read Only</option>
            </select>
        </div>
        <hr>
        <div class="well-big">
            <section class="form-wrap">
                <h1>Add A New Dataset</h1>
                <form id="addDatasetForm" onsubmit="addDataset()">
                  <input type="name" id="nameInputAddDataset" placeholder="Name" required>
                  <input type="description" id="passwordInputAddDataset" placeholder="Description" pattern=".*" required>
                  <input type="annotation" id="annotationInputAddDataset" placeholder="Annotation" pattern=".*" required>
                  <input type="submit" value="Sign in">
                </form>
            </section>
        </div>
        <div class="well-big">
            <h1>Upload File</h1>
            <input type='file' id='input_dom_element'></input>
        </div>
        
        <script>
            // Initialize the Amazon Cognito credentials provider
            var userPoolId = 'us-west-2_7jPSeH5Rn';
            var userPoolClientId = '1akumpo5etkim7pgi3flvosjl6';
            var userPoolARN = 'arn:aws:cognito-idp:us-west-2:179462354929:userpool/us-west-2_7jPSeH5Rn';
            var userIdentityId = 'us-west-2:4bcfca78-67ae-4117-8191-e40cdf742cfc';
            AWS.config.region = 'us-west-2';  
            AWS.config.credentials = new this.AWS.CognitoIdentityCredentials({
                IdentityPoolId: userIdentityId
            });
            var poolData = {
                UserPoolId: userPoolId,
                ClientId: userPoolClientId
            };
            var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
            var cognitoidentityserviceprovider = new AWS.CognitoIdentityServiceProvider();
            const Groups = {
                'admin': 'admin',
                'readonly': 'readonly',
                'readwrite': 'readwrite'
            };

            // State Variables
            var auth;
            var sessionInfo;
            var userName;
            var groupsAndRoles;
            // FUNCTIONS
            function register(email, password, onSuccess, onFailure) {
                var dataEmail = {
                    Name: 'email',
                    Value: email
                };
                debugger;
                var attributeEmail = new AmazonCognitoIdentity.CognitoUserAttribute(dataEmail);

                userPool.signUp(toUsername(email), password, [attributeEmail], null,
                    function signUpCallback(err, result) {
                        if (!err) {
                            onSuccess(result);
                        } else {
                            onFailure(err);
                        }
                    }
                );
            };

            function verify(email, code, onSuccess, onFailure) {
                createCognitoUser(email).confirmRegistration(code, true, function confirmCallback(err, result) {
                    if (!err) {
                        onSuccess(result);
                    } else {
                        onFailure(err);
                    }
                });
            };

            function signin(email, password, onSuccess, onFailure) {
                var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails({
                    Username: toUsername(email),
                    Password: password
                });

                var cognitoUser = createCognitoUser(email);
                cognitoUser.authenticateUser(authenticationDetails, {
                    onSuccess: function(au){
                        console.log("SUCCESS!");
                        console.log(au);
                        auth = au;
                        userName = auth.getIdToken().payload['cognito:username'];
                        groupsAndRoles = getUserGroup(cognitoUser);
                        },
                    onFailure: function(err){
                        console.log("Failed...");
                        alert(err);
                        }
                });
            };

            function signOut(event) {
                userPool.getCurrentUser().signOut();
                auth = null;
            };

            function createCognitoUser(email) {
                return new AmazonCognitoIdentity.CognitoUser({
                    Username: toUsername(email),
                    Pool: userPool
                });
            };

            function toUsername(email) {
                return email.replace('@', '-at-');
            };

            // Event Handlers
            $(function onDocReady() {
                $('#signinForm').submit(handleSignin);
                $('#registrationForm').submit(handleRegister);
                $('#verifyForm').submit(handleVerify);
            });
            function handleSignin(event) {
                var email = $('#emailInputSignin').val();
                var password = $('#passwordInputSignin').val();
                console.log('test 1');
                event.preventDefault();
                signin(email, password);
            };

            function handleRegister(event) {
                var email = $('#emailInputRegister').val();
                var password = $('#passwordInputRegister').val();
                var password2 = $('#password2InputRegister').val();
                
                console.log('in handleRegister...');
                var onSuccess = function registerSuccess(result) {
                    var cognitoUser = result.user;
                    console.log('user name is ' + cognitoUser.getUsername());
                    var confirmation = ('Registration successful. Please check your email inbox or spam folder for your verification code.');
                    if (confirmation) {
                        console.log('==============> Registered....');
                        // window.location.href = 'verify.html';
                    }
                };
                var onFailure = function registerFailure(err) {
                    alert(err);
                };
                event.preventDefault();

                if (password === password2) {
                    register(email, password, onSuccess, onFailure);
                } else {
                    alert('Passwords do not match');
                }
            };

            function handleVerify(event) {
                var email = $('#emailInputVerify').val();
                var code = $('#codeInputVerify').val();
                event.preventDefault();
                verify(email, code,
                    function verifySuccess(result) {
                        console.log('call result: ' + result);
                        console.log('Successfully verified');
                        alert('Verification successful. You will now be redirected to the login page.');
                        console.log('==============> Verified....');
                        // window.location.href = signinUrl;
                    },
                    function verifyError(err) {
                        alert(err);
                    }
                );
            };

            function handleFile(e) {
                var files = e.target.files, f = files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    data = e.target.result;
                    if(!rABS) data = new Uint8Array(data);
                }
            };

            function getUserGroup(cognitoUser){
                var groups;
                var roles;
                cognitoUser.getSession(function(err, session) {
                            if (err) {
                               alert(err);
                                return;
                            }
                            console.log('session validity: ' + session.isValid());
                            console.dir(session.getIdToken().payload);
                            sessionInfo = session.getIdToken().payload;
                            groups = sessionInfo['cognito:groups'];
                            console.log("Groups this user belongs to: " + groups);
                            roles = sessionInfo['cognito:roles'];
                            console.log("Roles this user owns :" + roles);
                            
                });
                return {"groups": groups,
                        "roles": roles};
            };
            
                
            function assignUserToGroup(value) {
                var params = {
                    GroupName: value, /* required */
                    UserPoolId: userPoolId, /* required */
                    Username: userName /* required */
                };
                cognitoidentityserviceprovider.adminAddUserToGroup(params, function(err, data) {
                    if (err) console.log(err, err.stack); // an error occurred
                    else     console.log(data);           // successful response
                    });
            };

            input_dom_element.addEventListener('change', handleFile, false);
        </script>
    </body>
</html>
